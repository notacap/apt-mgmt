{% extends 'base.html' %}
{% load form_tags %}

{% block title %}Calendar - Month View{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Calendar</h1>
        <div class="flex space-x-2">
            <a href="{% url 'events:create_event' %}" 
               class="inline-flex items-center px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                New Event
            </a>
        </div>
    </div>

    <!-- Navigation and View Toggle -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 mb-6">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                <!-- Calendar Navigation -->
                <div class="flex items-center space-x-4">
                    <button onclick="navigateMonth(-1)" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white" id="current-month">
                        {{ current_month_year|date:"F Y" }}
                    </h2>
                    <button onclick="navigateMonth(1)" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                    <button onclick="goToToday()" class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                        Today
                    </button>
                </div>

                <!-- View Toggle -->
                <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                    <a href="{% url 'events:calendar_month' %}" 
                       class="px-3 py-2 text-sm font-medium rounded-md bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm">
                        Month
                    </a>
                    <a href="{% url 'events:calendar_week' %}" 
                       class="px-3 py-2 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                        Week
                    </a>
                    <a href="{% url 'events:calendar_day' %}" 
                       class="px-3 py-2 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                        Day
                    </a>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="px-6 py-4">
            <form method="GET" class="flex flex-wrap items-center gap-4">
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Property:</label>
                    {{ filter_form.property }}
                </div>
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Type:</label>
                    {{ filter_form.event_type }}
                </div>
                <div class="flex items-center space-x-2">
                    {{ filter_form.assigned_to_me }}
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Assigned to me</label>
                </div>
                <div class="flex items-center space-x-2">
                    {{ filter_form.created_by_me }}
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Created by me</label>
                </div>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">
                    Filter
                </button>
                <a href="{% url 'events:calendar_month' %}" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 text-sm font-medium rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">
                    Clear
                </a>
            </form>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700" id="calendar-container">
        
        <div class="grid grid-cols-7 gap-0 border-b border-gray-200 dark:border-gray-700">
            <!-- Day Headers -->
            <div class="p-4 text-center text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700">Sun</div>
            <div class="p-4 text-center text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700">Mon</div>
            <div class="p-4 text-center text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700">Tue</div>
            <div class="p-4 text-center text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700">Wed</div>
            <div class="p-4 text-center text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700">Thu</div>
            <div class="p-4 text-center text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700">Fri</div>
            <div class="p-4 text-center text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700">Sat</div>
        </div>
        
        <!-- Calendar Days -->
        <div class="grid grid-cols-7 gap-0" id="calendar-days">
            <!-- Days will be populated by JavaScript -->
        </div>
    </div>

    <!-- Legend -->
    <div class="mt-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Event Types</h3>
        <div class="flex flex-wrap gap-4">
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-amber-500 rounded"></div>
                <span class="text-sm text-gray-700 dark:text-gray-300">Maintenance</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-blue-500 rounded"></div>
                <span class="text-sm text-gray-700 dark:text-gray-300">Meeting</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-purple-500 rounded"></div>
                <span class="text-sm text-gray-700 dark:text-gray-300">Inspection</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-emerald-500 rounded"></div>
                <span class="text-sm text-gray-700 dark:text-gray-300">Work Schedule</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-red-500 rounded"></div>
                <span class="text-sm text-gray-700 dark:text-gray-300">Lease Signing</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-cyan-500 rounded"></div>
                <span class="text-sm text-gray-700 dark:text-gray-300">Property Showing</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-gray-500 rounded"></div>
                <span class="text-sm text-gray-700 dark:text-gray-300">General</span>
            </div>
        </div>
    </div>
</div>

<script>
let currentDate = new Date('{{ today|date:"Y-m-d" }}');
let events = [];

// Initialize calendar
document.addEventListener('DOMContentLoaded', function() {
    loadEvents();
    renderCalendar();
});

function loadEvents() {
    const startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    
    fetch(`{% url 'events:get_events_json' %}?start=${startDate.toISOString().split('T')[0]}&end=${endDate.toISOString().split('T')[0]}`)
        .then(response => response.json())
        .then(data => {
            events = data;
            renderCalendar();
        })
        .catch(error => console.error('Error loading events:', error));
}

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Update month display
    document.getElementById('current-month').textContent = 
        currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    // Calculate first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay()); // Start from Sunday
    
    const calendarDays = document.getElementById('calendar-days');
    calendarDays.innerHTML = '';
    
    // Generate 6 weeks (42 days)
    for (let i = 0; i < 42; i++) {
        const day = new Date(startDate);
        day.setDate(startDate.getDate() + i);
        
        const dayElement = createDayElement(day, month);
        calendarDays.appendChild(dayElement);
    }
}

function createDayElement(date, currentMonth) {
    const dayDiv = document.createElement('div');
    const isCurrentMonth = date.getMonth() === currentMonth;
    const isToday = date.toDateString() === new Date().toDateString();
    
    dayDiv.className = `min-h-24 p-2 border-b border-r border-gray-200 dark:border-gray-700 ${
        isCurrentMonth ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-900'
    } ${isToday ? 'bg-blue-50 dark:bg-blue-900' : ''}`;
    
    // Day number
    const dayNumber = document.createElement('div');
    dayNumber.className = `text-sm font-medium ${
        isCurrentMonth ? 'text-gray-900 dark:text-white' : 'text-gray-400 dark:text-gray-600'
    } ${isToday ? 'text-blue-600 dark:text-blue-400' : ''}`;
    dayNumber.textContent = date.getDate();
    dayDiv.appendChild(dayNumber);
    
    // Events for this day (including multi-day events)
    const dayEvents = events.filter(event => {
        const eventStart = new Date(event.start);
        const eventEnd = new Date(event.end);
        const currentDate = new Date(date);
        
        // Use date strings for comparison to avoid timezone issues
        const eventStartStr = event.start.split('T')[0]; // Get YYYY-MM-DD part
        const eventEndStr = event.end.split('T')[0];     // Get YYYY-MM-DD part
        const currentDateStr = currentDate.toISOString().split('T')[0]; // Get YYYY-MM-DD part
        
        // Check if current date falls within event duration using string comparison
        return currentDateStr >= eventStartStr && currentDateStr <= eventEndStr;
    });
    
    dayEvents.forEach(event => {
        // Use string comparison for consistency
        const eventStartStr = event.start.split('T')[0];
        const eventEndStr = event.end.split('T')[0];
        const currentDateStr = new Date(date).toISOString().split('T')[0];
        
        const isFirstDay = currentDateStr === eventStartStr;
        const isLastDay = currentDateStr === eventEndStr;
        const isMultiDay = eventEndStr > eventStartStr;
        
        const eventDiv = document.createElement('div');
        
        // Different styling for multi-day events        
        if (isMultiDay) {
            // Multi-day event styling
            let classes = 'mt-1 px-2 py-1 text-xs cursor-pointer hover:opacity-80 relative';
            
            if (isFirstDay) {
                classes += ' rounded-l';
                if (event.allDay) {
                    eventDiv.textContent = event.title;
                } else {
                    eventDiv.textContent = `${event.title} (${new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})})`;
                }
            } else if (isLastDay) {
                classes += ' rounded-r';
                if (event.allDay) {
                    eventDiv.textContent = ''; // Empty on last day for all-day events
                } else {
                    eventDiv.textContent = `(ends ${new Date(event.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})})`;
                }
            } else {
                classes += ''; // No border radius for middle days
                eventDiv.textContent = ''; // Empty on middle days
            }
            
            eventDiv.className = classes;
            
            // Add opacity to continuation days
            if (!isFirstDay) {
                eventDiv.style.opacity = '0.7';
            }
        } else {
            // Single day event styling
            eventDiv.className = 'mt-1 px-2 py-1 text-xs rounded truncate cursor-pointer hover:opacity-80';
            if (event.allDay) {
                eventDiv.textContent = event.title;
            } else {
                eventDiv.textContent = `${event.title} (${new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})})`;
            }
        }
        
        eventDiv.style.backgroundColor = event.backgroundColor;
        eventDiv.style.color = 'white';
        eventDiv.onclick = () => window.location.href = event.url;
        dayDiv.appendChild(eventDiv);
    });
    
    return dayDiv;
}

function navigateMonth(direction) {
    currentDate.setMonth(currentDate.getMonth() + direction);
    loadEvents();
}

function goToToday() {
    currentDate = new Date();
    loadEvents();
}
</script>
{% endblock %}